---
title: "Data and distillation models"
date: "`r format(Sys.Date(), '%d %b %Y')`"
number-sections: true
number-offset: 0
toc: true
toc-depth: 2
fig-width: 6
fig-height: 4
df-print: tibble
embed-resources: true
format: 
  html: 
    code-tools: true
    code-fold: show
    code-summary: "Show the code"
    toc-float: true
  pdf:
    toc: false
  docx: 
    number-sections: false
knitr: 
  opts_chunk: 
    fig.path: "plots/"
    fig.keep: "all"
    dev: ['png', 'pdf']
    dev.args: 
      pdf: 
        encoding: 'WinAnsi'
        useDingbats: false
crossref:
  fig-prefix: Fig.
  tbl-prefix: Table
  ref-hyperlink: true
editor: source
editor_options: 
  chunk_output_type: console
---

# Setup

Using `r R.version.string` , @R, and tidyverse version `r packageVersion("tidyverse")`, @tidyverse.

```{r}
#| label: setup
#| message: false

# load packages
library(tidyverse)

# load scripts
source("scripts/plotting_functions.R")
source("scripts/table_functions.R")
```
# Data

```{r}
# load data
data <- readxl::read_excel("data/batch_culture_data.xlsx") |>
  transmute(
    growth_phase = growth_phase,
    crds_CO2 = N2_vol.mL / sample_vol.mL * quant_CO2,
    gctcd_CO2 = areas_CO2,
    d13C_CO2 = CO2_corrected_standards,
    d13C_CH4 = CH4_corrected_standards,
    d13C_phytane = d13C_phytane.permil,
    d13C_biomass = d13C_biomass.permil
  )
data |> knitr::kable()

# pivot longer
data_long <- data |>
  pivot_longer(
    cols = -"growth_phase",
    names_to = c(".value", "compound"),
    names_pattern = "([^_]+)_(.+)"
  ) |>
  filter(!is.na(crds) | !is.na(gctcd) | !is.na(d13C))
```

# Calculations

## Averages

```{r}
# calculate fraction of CO2 remaining
data_f <- 
  data_long |>
  filter(compound == "CO2") |>
  pivot_longer(
    cols = c("crds", "gctcd"),
    names_to = "method", values_to = "signal"
  ) |>
  mutate(
    .by = "method",
    f_CO2 = signal / mean(signal[growth_phase == "t0"], na.rm = TRUE)
  ) |>
  summarize(
    .by = c("growth_phase", "method"),
    f_CO2 = mean(f_CO2, na.rm = TRUE)
  ) |>
  filter(!is.na(f_CO2)) |>
  summarize(
    .by = "growth_phase",
    f_CO2_avg = mean(f_CO2),
    f_CO2_sd = sd(f_CO2),
    f_CO2_min = min(f_CO2),
    f_CO2_max = max(f_CO2)
  )

# calculate d13C averages, sds, mins, maxs
data_avgs <- data_long |>
  filter(!is.na(d13C)) |>
  summarize(
    .by = c("growth_phase", "compound"),
    d13C_avg = mean(d13C),
    d13C_sd = sd(d13C),
    d13C_min = min(d13C),
    d13C_max = max(d13C)
  ) |>
  # bring in the f data
  left_join(data_f, by = c("growth_phase")) |>
  # make it 0 for stationary phase
  mutate(
    across(starts_with("f_"), ~ifelse(is.na(.x), 0, .x))
  )

data_avgs |> knitr::kable(d = 2)
```

## Data table

```{r}
data_avgs |>
  arrange(desc(f_CO2_avg)) |>
  select("growth_phase", "compound", "d13C_avg", "f_CO2_avg") |>
  mutate(
    f_CO2_avg = format_with_decimals(100 * f_CO2_avg, 1) |> paste0("%"),
    d13C_avg = format_with_decimals(d13C_avg, 1, include_plus = TRUE) |> paste0("\U2030")
  ) |>
  pivot_wider(names_from = compound, values_from = d13C_avg, values_fill = "") |>
  rename(
    "CO2 remaining" = "f_CO2_avg",
    "δ13CO2" = "CO2",
    "δ13CH4" = "CH4",
    "δ13Cbiomass" = "biomass",
    "δ13Cphytane" = "phytane"
  ) |>
  export_to_excel(file = "output/table1.xlsx")
```


## Derived parameters

$$
\begin{aligned}
\alpha_{B/CH4} &= \frac{R_{B_f}}{R_{CH4_f}} = \frac{\delta_{B_f} - 1}{\delta_{CH4_f} - 1} \\
Y &= \frac{R_{CO2_0} - R_{CH4_f}}{R_{B_f} - R_{CH4_f}} = \frac{\delta_{CO2_0} - \delta_{CH4_f}}{\delta_{B_f} - \delta_{CH4_f}}
\end{aligned}
$$

```{r}
# calculate derived parameters
params <- data_avgs |>
  with({
    d_CO2_0 <- d13C_avg[growth_phase == "t0" & compound == "CO2"]
    d_CH4_f <- d13C_avg[growth_phase == "stationary" & compound == "CH4"]
    d_B_f <- d13C_avg[growth_phase == "stationary" & compound == "biomass"]
    list(
      # t0 d13CO2
      d_CO2_t0 = d_CO2_0,
      # final d13C biomass
      d_B_f = d_B_f,
      # calculate the biomass methane fractionation factor
      a_B_CH4 = (d_B_f/1000 + 1) / (d_CH4_f/1000 + 1),
      # calculate the net yield (Y)
      Y = (d_CO2_0 - d_CH4_f)/(d_B_f - d_CH4_f)
    )
  }) 
sprintf("The estimated yield is %.1f%%.\nThe estimated biomass offset from methane is %.1f\U2030.", 
        100 * params$Y, 1000 * (params$a_B_CH4 - 1)) |> message()
```


# Modelling the data

## One step models

### Catabolism only

$$
\begin{aligned}
\text{Rxn: }CO_2 &\rightarrow CH_4 \\
\alpha &= \alpha_{CO2\rightarrow CH4} \\
\frac{R_{CO2}}{R_{CO2_0}} &= f^{\alpha_{CO2\rightarrow CH4} - 1} \\
\text{MB: }R_{CO2_0} &= f \cdot R_{CO2} + (1 - f) \cdot R_{CH4} \\
\rightarrow
  \frac{R_{CH4}}{R_{CO2_0}}&= \frac{1 - f^{\alpha_{CO2\rightarrow CH4}}}{1-f}
\end{aligned}
$$

### Catabolism + anabolism

$$
\begin{aligned}
\text{Rxn: }CO_2 &\rightarrow (1 - Y) \cdot CH_4 + Y \cdot B  \\
\alpha &= (1-Y) \cdot \alpha_{CO2\rightarrow CH4} + Y \cdot  \alpha_{CO2\rightarrow B} \\
  &= (1-Y) \cdot \alpha_{CO2\rightarrow CH4} + Y \cdot \alpha_{B/CH4} \cdot \alpha_{CO2\rightarrow CH4} \\
  &= \alpha_{CO2\rightarrow CH4} \cdot \left(1 + Y \cdot ( \alpha_{B/CH4} - 1 )\right)\\
  &= \alpha_{CO2\rightarrow CH4} \cdot k_1 \;\;|\text{ with } k_1 = 1 + Y \cdot ( \alpha_{B/CH4} - 1 )\\
\frac{R_{CO2}}{R_{CO2_0}} &= f^{\alpha_{CO2\rightarrow CH4} \cdot k_1 - 1} \\
\text{MB: }R_{CO2_0} &= f \cdot R_{CO2} + (1 - f) \cdot (1 - Y) \cdot R_{CH4} + (1 - f) \cdot Y \cdot R_{B} \\
\rightarrow
  \frac{R_{CH4}}{R_{CO2_0}} &= \frac{1 - f^{
  \alpha_{CO2\rightarrow CH4} \cdot \left(1 + Y \cdot ( \alpha_{B/CH4} - 1 )\right)
}}{(1 - f) \cdot (1 + Y \cdot (\alpha_{B/CH4} - 1))} \\
  &= \frac{1 - f^{\alpha_{CO2\rightarrow CH4} \cdot k_1}}{(1-f)\cdot k_1}
\end{aligned}
$$

### Implementation

```{r}
# general data for model (i.e. not phytane)
data_for_model <- data_avgs |> filter(compound %in% c("CO2", "CH4", "biomass"))

# d13C functions
# for catabolism only (Y = 0) and catabolism + anabolism (Y > 0)
calculate_k1 <- function(alpha_B_CH4, Y) return(1 + Y * (alpha_B_CH4 - 1))
calculate_d13C_CO2 <- function(f, alpha_CO2_CH4, alpha_B_CH4 = 1, d13C_CO2_t0, Y = 0) {
  k <- calculate_k1(alpha_B_CH4, Y)
  (f^(alpha_CO2_CH4 * k - 1) * (d13C_CO2_t0/1000 + 1) - 1) * 1000
}
calculate_d13C_CH4 <- function(f, alpha_CO2_CH4, alpha_B_CH4 = 1, d13C_CO2_t0, Y = 0) {
  k <- calculate_k1(alpha_B_CH4, Y)
  ( (1 - f^(alpha_CO2_CH4 * k)) / ((1 - f) * k) * (d13C_CO2_t0/1000 + 1) - 1) * 1000
}
calculate_d13C_B <- function(f, alpha_CO2_CH4, alpha_B_CH4 = 1, d13C_CO2_t0, Y = 0) {
  dCH4 <- calculate_d13C_CH4(f, alpha_CO2_CH4, alpha_B_CH4, d13C_CO2_t0, Y)
  return((alpha_B_CH4 * (dCH4/1000 + 1) - 1) * 1000)
}

# calculate d13C for the different compounds
calculate_d13C <- function(f, compound, alpha_CO2_CH4, alpha_B_CH4 = 1, Y = 0) {
  tibble(f = f, compound = compound) |>
    mutate(
      .by = "compound",
      d13C_est = 
        do.call(if (compound[1] == "CO2") calculate_d13C_CO2 
          else if (compound[1] == "CH4") calculate_d13C_CH4
          else if (compound[1] == "biomass") calculate_d13C_B
          else stop("shouldn't happen"),
          list(
            f = .data$f,
            alpha_CO2_CH4 = !!alpha_CO2_CH4, 
            alpha_B_CH4 = !!alpha_B_CH4,
            d13C_CO2_t0 = params$d_CO2_t0,
            Y = !!Y
          )
      )) |>
    pull(d13C_est)
}
```

### Results

```{r}
# catabolism only
cat_only <- 
  nls(
    d13C_avg ~ calculate_d13C(f_CO2_avg, compound, alpha_CO2_CH4),
    data = data_for_model, start = list(alpha_CO2_CH4 = 1)
  )
cat_only_result <- bind_cols(broom::glance(cat_only), broom::tidy(cat_only))

# anabolism & catabolism
# non-linear least squares fit
cat_anab <- 
  nls(
    d13C_avg ~ calculate_d13C(
      f_CO2_avg, compound, 
      alpha_CO2_CH4 = alpha_CO2_CH4,
      alpha_B_CH4 = alpha_B_CH4[1],
      Y = Y[1]),
    data = data_for_model |> mutate(Y = !!params$Y, alpha_B_CH4 = !!params$a_B_CH4), 
    start = list(alpha_CO2_CH4 = 1)
  )
cat_anab_result <- bind_cols(broom::glance(cat_anab), broom::tidy(cat_anab))

# results comparison
cat_only_result |>
  with(
  sprintf("For catabolism only:\nThe estimated fractionation between CO2 and CH4 is %.3f \U00B1 %.3f (%.1f \U00B1 %.1f\U2030)\nThe RMSE is %.1f\U2030.", 
        estimate, std.error, 1000 * (estimate - 1), 1000 * std.error, sigma) |> message()
  )
cat_anab_result |>
  with(
  sprintf("For catabolism + anabolism:\nThe measured (from final products) fractionation between biomass and CH4 is %.3f (%.1f\U2030).\nThe estimated fractionation between CO2 and CH4 is %.3f \U00B1 %.3f (%.1f \U00B1 %.1f\U2030)\nThe RMSE is %.1f\U2030.", 
          params$a_B_CH4, 1000 * (params$a_B_CH4 - 1),
          estimate, std.error, 1000 * (estimate - 1), 1000 * std.error, sigma) |> message()
  )
```

## Two step model: catabolism + partial anabolism

### Step 1

$$
\begin{aligned}
\text{Step 1: }f &\in [1, f_{s1}]\\
  CO_2 &\rightarrow (1 - Y_{s1}) \cdot CH_4 + Y_{s1} \cdot B  \\
  Y_{s1} &= \frac{Y}{1 - f_{s1}}\\
  \alpha_{s1} &= (1-Y_{s1}) \cdot \alpha_{CO2\rightarrow CH4} + Y_{s1} \cdot \alpha_{B/CH4} \cdot \alpha_{CO2\rightarrow CH4} \\ 
    &= \alpha_{CO2\rightarrow CH4} \cdot k_2 \;\;|\text{ with }
    k_2 = 1 + Y \cdot \frac{\alpha_{B/CH4} - 1}{1 - f_{s1}} \\
  \text{MB: }R_{CO2_0} &= f \cdot R_{CO2} + (1 - f) \cdot (1 - Y_{s1}) \cdot R_{CH4} + (1 - f) \cdot Y_{s1} \cdot R_{B} \\
  &= f \cdot R_{CO2} + \frac{1 - f}{1 - f_{s1}} \cdot (1 - f_{s1} - Y) \cdot R_{CH4} + \frac{1 - f}{1 - f_{s1}} \cdot Y \cdot R_{B}
\end{aligned}
$$

### Step 2

$$
\begin{aligned}
\text{Step 2: }f &\in \;]f_{s1},0]\\
  CO_2 &\rightarrow CH_4 \\
\alpha_{s2} &= \alpha_{CO2\rightarrow CH4} \\
  \text{MB: } R_{CO2_0} 
    &= f \cdot R_{CO2} + (f_{s1} - f + (1 - f_{s1}) \cdot  (1 - Y_{s1})) \cdot R_{CH4} + (1 - f_{s1}) \cdot Y_{s1} \cdot R_B \\
    &= f \cdot R_{CO2} + (1 - f - Y) \cdot R_{CH4} + Y \cdot R_B
\end{aligned}
$$

### Overall

$$
\begin{aligned}
\text{ for } f \in [1, f_{s1}] &:
  \left\{
    \begin{array}{l}
     \frac{R_{CO_2}}{R_{CO2_0}} &= f^{\alpha_{s1} - 1} = 
        f^{\alpha_{CO2\rightarrow CH4} \cdot k_2 - 1} \\
     \frac{R_{CH_4}}{R_{CO2_0}} &= 
        \frac{1 - f^{\alpha_{CO2\rightarrow CH4} \cdot k_2}}{(1-f)\cdot k_2} \\
     \frac{R_{B}}{R_{CO2_0}} &= \alpha_{B/CH4} \cdot \frac{R_{CH_4}}{R_{CO2_0}}
    \end{array}
  \right. \\

\text{ for } f \in \;]f_{s1},0] &:
  \left\{
    \begin{array}{l}
    \frac{R_{CO_2}}{R_{CO2_0}} &=
      \frac{R_{CO2_{s1}}}{R_{CO2_0}} \cdot \left( \frac{f}{f_{s1}} \right)^{\alpha_{s2} - 1} 
      = f_{s1}^{\alpha_{CO2\rightarrow CH4} \cdot k_2 - 1} \cdot 
        \left( \frac{f}{f_{s1}} \right)^{\alpha_{CO2\rightarrow CH4} - 1} \\
    \frac{R_{CH_4}}{R_{CO2_0}} &=
      \frac{
        \left(1 - f_{s1}^{\alpha_{CO2\rightarrow CH4} \cdot k_2} \cdot 
          \left( \frac{f}{f_{s1}} \right)^{\alpha_{CO2\rightarrow CH4}} \right) \cdot k_2 -       
          \alpha_{B/CH4} \cdot Y \cdot \frac{1 - f_{s1}^{\alpha_{CO2\rightarrow CH4} \cdot k_2}}{1 - f_{s1}}
      }{ (1 - f - Y) \cdot k_2 } \\
      \frac{R_{B}}{R_{CO2_0}} &= \alpha_{B/CH4} \cdot \frac{R_{CH_4}[f=f_{s1}]}{R_{CO2_0}}
    \end{array}
  \right. \\
  \text{ with }
    k_2 &= 1 + Y \cdot \frac{\alpha_{B/CH4} - 1}{1 - f_{s1}}
\end{aligned}
$$


and thus the overall B/CH4 fractionation factor and $f_{s1}$ are dependent on each other the following equation whose solution can be found numerically by root finding:

$$
\begin{aligned}
\frac{R_{B_{f=0}}}{R_{CO2_0}} 
  &= \frac{1 - f_{s1}^{\alpha_{CO2\rightarrow CH4} \cdot k_2}}{(1-f_{s1})\cdot k_2} \cdot \alpha_{B/CH4} \\
  &= \frac{1 - f_{s1}^{\alpha_{CO2\rightarrow CH4} \cdot (1 + Y \cdot \frac{\alpha_{B/CH4} - 1}{1 - f_{s1}})}}{1-f_{s1} + Y \cdot (\alpha_{B/CH4} - 1)} \cdot \alpha_{B/CH4}
\end{aligned}
$$

### Implementation

```{r}
# d13C functions
# for the 2 step process
calculate_k2 <- function(f_s1, alpha_B_CH4, Y) return(1 - Y * (1 - alpha_B_CH4) / (1 - f_s1))
calculate_2step_d13C_CO2 <- function(f, f_s1, alpha_CO2_CH4, alpha_B_CH4, d13C_CO2_t0, Y) {
  k2 <- calculate_k2(f_s1 = f_s1, alpha_B_CH4 = alpha_B_CH4, Y = Y)
  alpha <- ifelse(
    f >= f_s1,
    f^(alpha_CO2_CH4 * k2 - 1),
    f_s1^(alpha_CO2_CH4 * k2 - 1) * (f/f_s1)^(alpha_CO2_CH4 - 1)
  )
  return((alpha * (d13C_CO2_t0/1000 + 1) - 1) * 1000)
}
calculate_2step_d13C_CH4 <- function(f, f_s1, alpha_CO2_CH4, alpha_B_CH4, d13C_CO2_t0, Y) {
  k2 <- calculate_k2(f_s1 = f_s1, alpha_B_CH4 = alpha_B_CH4, Y = Y)
  alpha <- ifelse(
    f >= f_s1,
    (1 - f^(alpha_CO2_CH4 * k2)) / ((1 - f) * k2),
    ( (1 - f_s1^(alpha_CO2_CH4 * k2) * (f/f_s1)^alpha_CO2_CH4 ) * k2 - 
        alpha_B_CH4 * Y * (1 - f_s1 ^(alpha_CO2_CH4 * k2)) / (1 - f_s1)  ) / 
      ((1 - f - Y) * k2)
  )
  return((alpha * (d13C_CO2_t0/1000 + 1) - 1) * 1000)
}
calculate_2step_d13C_B <- function(f, f_s1, alpha_CO2_CH4, alpha_B_CH4, d13C_CO2_t0, Y) {
  dCH4 <- calculate_2step_d13C_CH4(
    f = ifelse(f >= f_s1, f, f_s1), f_s1 = f_s1, alpha_CO2_CH4 = alpha_CO2_CH4,
    alpha_B_CH4 = alpha_B_CH4, d13C_CO2_t0 = d13C_CO2_t0, Y = Y
  )
  return((alpha_B_CH4 * (dCH4/1000 + 1) - 1) * 1000)
}
# root-finding calculation to get alpha_B/CH4 from f_s1
calculate_alpha_B_CH4_from_f_s1 <- function(d13C_B_f, f_s1, alpha_CO2_CH4, d13C_CO2_t0, Y) {
  uniroot(
    function(a) d13C_B_f  - calculate_2step_d13C_B(
      f = f_s1, f_s1 = f_s1, 
      alpha_CO2_CH4 = alpha_CO2_CH4, alpha_B_CH4 = a, 
      d13C_CO2_t0 = d13C_CO2_t0, Y = Y
    ),
    c(0, 2)
  )$root
}

# calculate d13C for the different compounds
calculate_2step_d13C <- function(f, f_s1, compound, alpha_CO2_CH4, alpha_B_CH4 = NULL, Y = params$Y) {
  # fractionation factor for biomass vs CH4
  if (is.null(alpha_B_CH4)) {
    alpha_B_CH4 <- 
      calculate_alpha_B_CH4_from_f_s1(
        d13C_B_f = params$d_B_f,
        f_s1 = f_s1, alpha_CO2_CH4 = alpha_CO2_CH4,
        d13C_CO2_t0 = params$d_CO2_t0,
        Y = Y
      )
  }
  
  # calculate
  tibble(f = f, compound = compound) |>
    mutate(
      .by = "compound",
      d13C_est = 
        do.call(if (compound[1] == "CO2") calculate_2step_d13C_CO2 
          else if (compound[1] == "CH4") calculate_2step_d13C_CH4
          else if (compound[1] == "biomass") calculate_2step_d13C_B
          else stop("shouldn't happen"),
          list(
            f = .data$f,
            f_s1 = !!f_s1, 
            alpha_CO2_CH4 = !!alpha_CO2_CH4, 
            alpha_B_CH4 = !!alpha_B_CH4,
            d13C_CO2_t0 = params$d_CO2_t0,
            Y = !!Y
          )
      )) |>
    pull(d13C_est)
}
```

### Results

```{r}
# 2 step process
# non-linear least squares fit
solve_2step_nls <- function(f_s1) {
  cat_anab_partial <- 
  nls(
    d13C_avg ~ calculate_2step_d13C(
      f_CO2_avg, f_s1 = f_s1[1],
      compound, alpha_CO2_CH4 = alpha_CO2_CH4,
      Y = Y[1]),
    data = data_for_model |> 
      mutate(Y = !!params$Y, f_s1 = !!f_s1), 
    start = list(alpha_CO2_CH4 = 1)
  )
  out <- bind_cols(broom::glance(cat_anab_partial), broom::tidy(cat_anab_partial))
  alpha_B_CH4 <- 
    calculate_alpha_B_CH4_from_f_s1(
      d13C_B_f = params$d_B_f,
      f_s1 = f_s1, alpha_CO2_CH4 = out$estimate[1],
      d13C_CO2_t0 = params$d_CO2_t0,
      Y = params$Y
    )
  return(mutate(out, alpha_B_CH4 = alpha_B_CH4, .before = 1L))
}

# explore solution space
cat_anab_partial_results <- 
  tibble(
    f_s1 = seq(0, 0.31, by = 0.01),
    result = map(f_s1, solve_2step_nls)
  ) |>
  unnest(result)

# printout
cat_anab_partial_results |>
  filter(f_s1 == 0.15) |>
  with(
  sprintf("For catabolism + partial anabolism:\nIf the f_CO2 at which anabolism stops is set to %.2f%%\nThe estimated fractionation between CO2 and CH4 is %.3f \U00B1 %.3f (%.1f \U00B1 %.1f\U2030).\nFor all solutions, this ranges from %.3f (%.1f \U2030) to %.3f (%.1f \U2030) with virtually identical errors.\nThe resulting fractionation between biomass and methane is %.3f (%.1f\U2030).\nThe RMSE of the fit is %.1f\U2030.",
        f_s1 * 100, estimate, std.error, 1000 * (estimate - 1), 1000 * std.error, 
        min(cat_anab_partial_results$estimate), 1000 * (min(cat_anab_partial_results$estimate) - 1),
        max(cat_anab_partial_results$estimate), 1000 * (max(cat_anab_partial_results$estimate) - 1), 
        alpha_B_CH4, 1000 * (alpha_B_CH4 - 1), sigma) |> message()
  )

```

# Visualization

## SI Fig: alpha_B/CH4 vs. f_s1

```{r}
#| label: fig-s1-alpha-B-CH4-vs-f-s1
#| fig-width: 8
#| fig-height: 5
cat_anab_partial_results |>
  ggplot() +
  aes(f_s1, alpha_B_CH4) +
  # data
  geom_line() +
  geom_point(data = ~filter(.x, f_s1 == 0.15), size = 3) +
  # scales
  scale_x_reverse(
    breaks = seq(0, 1, by = 0.05),
    expand = c(0, 0), labels = scales::label_percent()
  ) +
  scale_y_continuous(
    labels = function(x) {
      sprintf("%.3f\n(%+.0f\U2030)", x, 1000 * (x-1))
    }
  ) +
  # design
  theme_figure(grid = FALSE, plot_margin = margin(t = 0.03, r = 0.05, unit = "npc")) +
  labs(
    x = "CO2 remaining when anabolism stops", 
    y = expression(alpha["B/CH4"])
  )
```

```{r}
# model the data based on parameters ... (which get passed to the calculate functions)
model_data <- function(f, steps,...) {
  args <- rlang::dots_list(...)
  tibble(
    compound = c("CO2", "CH4", "biomass"),
    func = 
      if(steps == 1) 
        list(calculate_d13C_CO2, calculate_d13C_CH4, calculate_d13C_B)
      else if (steps == 2)
        list(calculate_2step_d13C_CO2, calculate_2step_d13C_CH4, calculate_2step_d13C_B)
      else stop("not implemented")
  ) |>
    mutate(
      data = map(func, ~{
        tibble(f = !!f) |>
          mutate(d13C = .x(f, !!!args))
      })
    ) |>
    select(-"func") |>
    unnest("data") |>
    filter(!is.infinite(d13C), !is.nan(d13C)) 
}
```

## Fig: data + models

```{r}
#| label: fig-data-and-model
#| fig-width: 8
#| fig-height: 5
f_s1_set <- 0.15
data_avgs |> 
  ggplot() +
  aes(
    x = f_CO2_avg,
    y = d13C_avg,
    color = compound
  ) +
  # stationary phase
  annotate(
    "rect", ymin = -Inf, ymax = +Inf, xmin = -0.02, xmax = 0.04,
    color = NA, fill = "gray60"
  ) +
  # no growth phase if 2-step
  annotate(
    "rect", ymin = -Inf, ymax = +Inf, xmin = 0.04, xmax = f_s1_set,
    color = NA, fill = "gray90"
  ) +
  # model (1-step)
  geom_line(
    data = 
      crossing(
        model = "1-step",
        compound = c("CO2", "CH4", "biomass"),
        f = seq(1, 0, length.out = 1000)
      ) |>
      mutate(
        d13C = calculate_d13C(
          f, compound, 
          alpha_CO2_CH4 = cat_anab_result$estimate, 
          alpha_B_CH4 = params$a_B_CH4, Y = params$Y)
      ) |> filter(!is.infinite(d13C), !is.nan(d13C)),
    map = aes(x = f, y = d13C, linetype = model)
  ) +
  # model (2-step)
  geom_line(
    data = 
      crossing(
        model = "2-step",
        compound = c("CO2", "CH4", "biomass"),
        f = seq(1, 0, length.out = 1000)
      ) |>
      mutate(
        d13C = calculate_2step_d13C(
          f, f_s1 = f_s1_set, compound, 
          alpha_CO2_CH4 = filter(cat_anab_partial_results, f_s1 == f_s1_set)$estimate)
      ) |> filter(!is.infinite(d13C), !is.nan(d13C)),
    map = aes(x = f, y = d13C, linetype = model)
  ) +
  # starting line
  geom_hline(
    data = ~filter(.x, growth_phase == "t0", compound == "CO2"),
    map = aes(yintercept = d13C_avg), linetype = 3, linewidth = 1
  ) +
  # data (h errors not measured or smaller than symbol sizes)
  geom_errorbarh(
    map = aes(xmin = f_CO2_min, xmax = f_CO2_max), height = 0
  ) +
  geom_point(size = 4) +
  # scales
  scale_x_reverse(expand = c(0, 0), labels = scales::label_percent()) +
  scale_y_continuous(labels = function(x) paste0(x, "\U2030"), breaks = seq(-100, 100, 20)) +
  scale_color_brewer(palette = "Set1") +
  expand_limits(x = 1.03) +
  coord_cartesian(ylim = c(-40, +80)) +
  theme_figure(grid = FALSE) +
  labs(
    x = "CO2 remaining", 
    y = expression(delta^"13"*C),
    linetype = "distillation\nmodel"
  )
```




